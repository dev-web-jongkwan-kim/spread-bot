# CryptoSpreadBot ë¯¸ë¹„ ì‚¬í•­ ë° ì¶”ê°€ í•„ìš” í•­ëª©

## ë¶„ì„ ì¼ì
2024ë…„ 12ì›”

---

## 1. ë¯¸ë¹„ëœ í•­ëª© (ìš´ì˜ ê´€ë ¨)

### ğŸ”´ ì¤‘ìš”ë„: ë†’ìŒ

| í•­ëª© | í˜„ì¬ ìƒíƒœ | ì„¤ëª… |
|------|----------|------|
| **JWT í† í°** | âš ï¸ Base64 ì¸ì½”ë”© ì‚¬ìš© | í˜„ì¬ `AuthService`ì—ì„œ ì‹¤ì œ JWTê°€ ì•„ë‹Œ ë‹¨ìˆœ Base64 ì¸ì½”ë”© ì‚¬ìš©. í”„ë¡œë•ì…˜ì—ì„œëŠ” `jsonwebtoken` ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ êµì²´ í•„ìš” |
| **ê´€ë¦¬ì ì•Œë¦¼** | âŒ ì—†ìŒ | ê°€ì…/êµ¬ë… ë“± ê´€ë¦¬ì ë…¸í‹° ê¸°ëŠ¥ ì—†ìŒ |
| **ì´ë©”ì¼ ì‹œìŠ¤í…œ** | âŒ ì—†ìŒ | ì´ë©”ì¼ ë°œì†¡ ê¸°ëŠ¥ ì „í˜€ ì—†ìŒ (ë¹„ë°€ë²ˆí˜¸ ë³µêµ¬, ê³µì§€ ë“±) |
| **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** | âš ï¸ ìµœì†Œ | `app.controller.spec.ts` 1ê°œ íŒŒì¼ë§Œ ì¡´ì¬ |
| **ë””ë²„ê·¸ ë¡œê·¸** | âš ï¸ í”„ë¡œë•ì…˜ ì œê±° í•„ìš” | ì½”ë“œ ë‚´ `fetch('http://127.0.0.1:7242/ingest/...')` ë””ë²„ê·¸ ë¡œê·¸ ë‹¤ìˆ˜ ì¡´ì¬ (ì•½ 20+ ê³³) |

### ğŸŸ¡ ì¤‘ìš”ë„: ì¤‘ê°„

| í•­ëª© | í˜„ì¬ ìƒíƒœ | ì„¤ëª… |
|------|----------|------|
| **ë¡œê·¸ ë¡œí…Œì´ì…˜** | âŒ ì—†ìŒ | ë¡œê·¸ íŒŒì¼ ê´€ë¦¬/ë¡œí…Œì´ì…˜ ì„¤ì • ì—†ìŒ |
| **ë©”íŠ¸ë¦­ ìˆ˜ì§‘** | âš ï¸ ë¶€ë¶„ | Sentryë§Œ ìˆê³  Prometheus/Grafana ê°™ì€ ë©”íŠ¸ë¦­ ì‹œìŠ¤í…œ ì—†ìŒ |
| **ì•Œë¦¼ ì‹¤íŒ¨ ì¬ì‹œë„** | âš ï¸ ë¶€ë¶„ | Queueì— ìˆì§€ë§Œ ì‹¤ì œ ì¬ì‹œë„ ë¡œì§ì€ AlertServiceì—ì„œ ì§ì ‘ ë°œì†¡ ì¤‘ |
| **API ë²„ì €ë‹** | âŒ ì—†ìŒ | `/api/v1/` í˜•íƒœì˜ ë²„ì „ ê´€ë¦¬ ì—†ìŒ |
| **ê°ì‚¬ ë¡œê·¸** | âš ï¸ ë¶€ë¶„ | Log ì—”í‹°í‹° ìˆì§€ë§Œ ì‚¬ìš©ì í–‰ë™ ì¶”ì  ë¯¸í¡ |

### ğŸŸ¢ ì¤‘ìš”ë„: ë‚®ìŒ

| í•­ëª© | í˜„ì¬ ìƒíƒœ | ì„¤ëª… |
|------|----------|------|
| **êµ­ì œí™”** | âš ï¸ ë¶€ë¶„ | i18n ìˆì§€ë§Œ ì¼ë¶€ í…ìŠ¤íŠ¸ í•˜ë“œì½”ë”© |
| **A/B í…ŒìŠ¤íŠ¸** | âŒ ì—†ìŒ | |
| **ìºì‹œ ë¬´íš¨í™”** | âš ï¸ ë¶€ë¶„ | TTLë§Œ ìˆê³  ìˆ˜ë™ ë¬´íš¨í™” ì—†ìŒ |

---

## 2. ê´€ë¦¬ì í…”ë ˆê·¸ë¨ ì•Œë¦¼

### êµ¬í˜„ ê°€ëŠ¥ ì—¬ë¶€: âœ… ê°€ëŠ¥

í˜„ì¬ êµ¬ì¡°ë¥¼ í™œìš©í•˜ë©´ ì‰½ê²Œ êµ¬í˜„ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### í•„ìš”í•œ ì‘ì—…

#### 1. í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€
```bash
ADMIN_TELEGRAM_IDS=123456789,987654321  # ê´€ë¦¬ì í…”ë ˆê·¸ë¨ ID ëª©ë¡
```

#### 2. AdminNotificationService ì‹ ê·œ ìƒì„±
```typescript
// í•„ìš”í•œ ë©”ì„œë“œ:
- sendToAdmins(message: string)     // ëª¨ë“  ê´€ë¦¬ìì—ê²Œ ë°œì†¡
- notifyNewUser(user: User)         // ì‹ ê·œ ê°€ì… ì•Œë¦¼
- notifySubscription(event)         // êµ¬ë… ë³€ê²½ ì•Œë¦¼
- notifyError(error)                // ì‹¬ê°í•œ ì—ëŸ¬ ì•Œë¦¼
- notifyDailyStats()                // ì¼ì¼ í†µê³„ ìš”ì•½
```

#### 3. í˜¸ì¶œ ì§€ì 
- `auth.controller.ts` â†’ ë¡œê·¸ì¸/ê°€ì… ì‹œ
- `webhook.service.ts` â†’ êµ¬ë… ë³€ê²½ ì‹œ
- `http-exception.filter.ts` â†’ ì‹¬ê°í•œ ì—ëŸ¬ ë°œìƒ ì‹œ
- ìŠ¤ì¼€ì¤„ëŸ¬ â†’ ì¼ì¼ í†µê³„ ìš”ì•½

### ì•Œë¦¼ ë°›ì„ ìˆ˜ ìˆëŠ” ì´ë²¤íŠ¸

| ì´ë²¤íŠ¸ | ê°€ëŠ¥ ì—¬ë¶€ | ìš°ì„ ìˆœìœ„ |
|--------|----------|----------|
| ì‹ ê·œ ì‚¬ìš©ì ê°€ì… | âœ… | ë†’ìŒ |
| êµ¬ë… ì‹œì‘/ë³€ê²½/ì·¨ì†Œ | âœ… | ë†’ìŒ |
| ì¼ì¼ í†µê³„ ìš”ì•½ | âœ… | ì¤‘ê°„ |
| ì„œë²„ ì—ëŸ¬ ë°œìƒ | âœ… | ë†’ìŒ |
| ì‹¬ë³¼ ë™ê¸°í™” ì‹¤íŒ¨ | âœ… | ì¤‘ê°„ |
| Circuit Breaker ì—´ë¦¼ | âœ… | ë†’ìŒ |

### êµ¬í˜„ ì˜ˆì‹œ

```typescript
@Injectable()
export class AdminNotificationService {
  private adminIds: number[];

  constructor(
    @InjectBot() private readonly bot: Telegraf,
    private readonly config: ConfigService,
  ) {
    this.adminIds = (config.get('ADMIN_TELEGRAM_IDS') || '')
      .split(',')
      .map(id => parseInt(id.trim(), 10))
      .filter(id => !isNaN(id));
  }

  async sendToAdmins(message: string) {
    for (const adminId of this.adminIds) {
      try {
        await this.bot.telegram.sendMessage(adminId, message, {
          parse_mode: 'HTML',
        });
      } catch (error) {
        console.error(`Failed to send to admin ${adminId}:`, error);
      }
    }
  }

  async notifyNewUser(user: User) {
    const message = `
ğŸ†• <b>New User Registered</b>

ğŸ‘¤ Username: @${user.username || 'N/A'}
ğŸ“± Telegram ID: ${user.telegramId}
ğŸ“… Time: ${new Date().toISOString()}
    `;
    await this.sendToAdmins(message);
  }

  async notifySubscription(event: string, user: User, plan: string) {
    const emoji = event === 'created' ? 'ğŸ’°' : event === 'cancelled' ? 'âŒ' : 'ğŸ”„';
    const message = `
${emoji} <b>Subscription ${event.toUpperCase()}</b>

ğŸ‘¤ User: @${user.username || 'N/A'}
ğŸ“¦ Plan: ${plan}
ğŸ“… Time: ${new Date().toISOString()}
    `;
    await this.sendToAdmins(message);
  }
}
```

---

## 3. ì¶”ê°€ ê¶Œì¥ ì‚¬í•­ (ìš´ì˜)

### ì¦‰ì‹œ ì ìš© ê¶Œì¥

| í•­ëª© | ì„¤ëª… | ì˜ˆìƒ ì‹œê°„ |
|------|------|----------|
| **ë””ë²„ê·¸ ë¡œê·¸ ì œê±°** | ëª¨ë“  `fetch('http://127.0.0.1:7242/ingest/...` ì½”ë“œ ì œê±° í•„ìš”. ì•½ 20+ ê³³ì— ì¡´ì¬ | 1ì‹œê°„ |
| **JWT ì‹¤ì œ êµ¬í˜„** | í˜„ì¬ Base64 ì¸ì½”ë”©ì€ ë³´ì•ˆ ì·¨ì•½. `jsonwebtoken` íŒ¨í‚¤ì§€ëŠ” ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŒ | 2ì‹œê°„ |
| **ê´€ë¦¬ì ì•Œë¦¼ ì„œë¹„ìŠ¤** | TelegramService í™•ì¥í•˜ì—¬ êµ¬í˜„ | 3ì‹œê°„ |

### ì¤‘ê¸° ì ìš© ê¶Œì¥

| í•­ëª© | ì„¤ëª… | ì˜ˆìƒ ì‹œê°„ |
|------|------|----------|
| **ë¡œê·¸ ê´€ë¦¬** | Winston ë¡œê·¸ ë¡œí…Œì´ì…˜ ì„¤ì • ë˜ëŠ” ì™¸ë¶€ ë¡œê·¸ ì„œë¹„ìŠ¤ ì—°ë™ (Datadog, Logtail ë“±) | 2-4ì‹œê°„ |
| **í…ŒìŠ¤íŠ¸ ì¶”ê°€** | ìµœì†Œí•œ í•µì‹¬ ì„œë¹„ìŠ¤ ìœ ë‹› í…ŒìŠ¤íŠ¸, API í†µí•© í…ŒìŠ¤íŠ¸ | 8-16ì‹œê°„ |
| **ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ** | Prometheus + Grafana ë˜ëŠ” Better Stack, Datadog ë“± | 4-8ì‹œê°„ |

### ì¥ê¸° ì ìš© ê¶Œì¥

| í•­ëª© | ì„¤ëª… |
|------|------|
| **API ë²„ì €ë‹** | `/api/v1/` í˜•íƒœë¡œ ë³€ê²½í•˜ì—¬ í•˜ìœ„ í˜¸í™˜ì„± ë³´ì¥ |
| **ì´ë©”ì¼ ì‹œìŠ¤í…œ** | ê³µì§€, ë¹„ë°€ë²ˆí˜¸ ë³µêµ¬, êµ¬ë… ì•Œë¦¼ ë“± |
| **ê°ì‚¬ ë¡œê·¸ ê°•í™”** | ëª¨ë“  ì‚¬ìš©ì í–‰ë™ ì¶”ì  |

---

## 4. ë””ë²„ê·¸ ë¡œê·¸ ìœ„ì¹˜ (ì œê±° í•„ìš”)

ì½”ë“œ ë‚´ `fetch('http://127.0.0.1:7242/ingest/...')` í˜•íƒœì˜ ë””ë²„ê·¸ ë¡œê·¸:

```
backend/src/auth/auth.guard.ts
backend/src/api/api.controller.ts (ë‹¤ìˆ˜)
backend/src/exchange/exchange.service.ts (ë‹¤ìˆ˜)
backend/src/alert/alert.service.ts (ë‹¤ìˆ˜)
backend/src/user/user.service.ts
backend/src/telegram/telegram.service.ts (ë‹¤ìˆ˜)
```

### ì œê±° ë°©ë²•
1. í”„ë¡œì íŠ¸ ì „ì²´ì—ì„œ `fetch('http://127.0.0.1:7242` ê²€ìƒ‰
2. `// #region agent log` ~ `// #endregion` ë¸”ë¡ ì „ì²´ ì‚­ì œ

---

## 5. ìš”ì•½

### í˜„ì¬ ìƒíƒœ
- **í•µì‹¬ ê¸°ëŠ¥**: âœ… ì™„ë£Œ
- **ë³´ì•ˆ ê¸°ë³¸**: âš ï¸ ìˆ˜ì • í•„ìš” (JWT, ì¸ì¦)
- **ìš´ì˜ ë„êµ¬**: âš ï¸ ë¶€ë¶„ (ê´€ë¦¬ì ì•Œë¦¼, ë¡œê·¸ ê´€ë¦¬)
- **í…ŒìŠ¤íŠ¸**: âŒ ë¯¸í¡
- **ë¬¸ì„œí™”**: âœ… ì™„ë£Œ
- **ë°°í¬ ì¤€ë¹„**: âš ï¸ ê±°ì˜ ì™„ë£Œ (ë””ë²„ê·¸ ì½”ë“œ ì œê±° í•„ìš”)

### ë°°í¬ ì „ í•„ìˆ˜ ì‘ì—…
1. ë³´ì•ˆ ì·¨ì•½ì  ìˆ˜ì • (SECURITY_ANALYSIS.md ì°¸ê³ )
2. ë””ë²„ê·¸ ë¡œê·¸ ì œê±°
3. (ê¶Œì¥) ê´€ë¦¬ì ì•Œë¦¼ ì„œë¹„ìŠ¤ êµ¬í˜„

### ì˜ˆìƒ ì´ ì‘ì—… ì‹œê°„
- í•„ìˆ˜ ìˆ˜ì •: 8-12ì‹œê°„
- ê¶Œì¥ ì¶”ê°€: 16-24ì‹œê°„

